<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SCJ ã‚»ãƒŸãƒŠãƒ¼ç™»éŒ²</title>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'Hiragino Sans', 'Yu Gothic', sans-serif; background: #f0f2f5; color: #1a1a2e; min-height: 100vh; }

  header { background: #1a1a2e; color: #fff; padding: 16px 24px; display: flex; align-items: center; gap: 12px; }
  header h1 { font-size: 18px; font-weight: 700; }
  header span { font-size: 12px; color: #c9a84c; background: #c9a84c22; padding: 3px 10px; border-radius: 99px; }

  main { max-width: 860px; margin: 32px auto; padding: 0 16px; }

  /* â”€â”€ STEP ã‚«ãƒ¼ãƒ‰ â”€â”€ */
  .card { background: #fff; border-radius: 12px; padding: 28px; margin-bottom: 20px; box-shadow: 0 1px 4px #0001; }
  .card-title { font-size: 13px; font-weight: 700; color: #c9a84c; text-transform: uppercase; letter-spacing: .08em; margin-bottom: 14px; }

  /* â”€â”€ ãƒ‰ãƒ­ãƒƒãƒ—ã‚¾ãƒ¼ãƒ³ â”€â”€ */
  #drop-zone {
    border: 2px dashed #c9a84c; border-radius: 10px; padding: 48px;
    text-align: center; cursor: pointer; transition: background .2s;
  }
  #drop-zone.over { background: #c9a84c11; }
  #drop-zone p { color: #666; font-size: 15px; margin-top: 8px; }
  #drop-zone .icon { font-size: 48px; }
  #file-name { margin-top: 10px; font-size: 13px; color: #c9a84c; font-weight: 600; }
  #file-input { display: none; }

  /* â”€â”€ ãƒœã‚¿ãƒ³ â”€â”€ */
  .btn { display: inline-flex; align-items: center; gap: 6px; padding: 10px 22px; border-radius: 8px; border: none; font-size: 14px; font-weight: 700; cursor: pointer; transition: .15s; }
  .btn-primary { background: #1a1a2e; color: #fff; }
  .btn-primary:hover { background: #2a2a4e; }
  .btn-gold { background: #c9a84c; color: #1a1a2e; }
  .btn-gold:hover { background: #b8942f; }
  .btn:disabled { opacity: .4; cursor: not-allowed; }

  /* â”€â”€ ãƒ•ã‚©ãƒ¼ãƒ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ â”€â”€ */
  .form-group { margin-bottom: 18px; }
  label { display: block; font-size: 12px; font-weight: 700; color: #555; margin-bottom: 6px; }
  label .req { color: #e55; margin-left: 4px; }
  input[type=text], input[type=date], textarea, select {
    width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 8px;
    font-size: 14px; font-family: inherit; transition: border-color .2s;
  }
  input:focus, textarea:focus, select:focus { outline: none; border-color: #c9a84c; }
  textarea { min-height: 180px; resize: vertical; }

  /* â”€â”€ ã‚¿ã‚°å…¥åŠ› â”€â”€ */
  .tags-wrap { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px; }
  .tag { background: #1a1a2e11; border-radius: 99px; padding: 3px 10px; font-size: 12px; display: flex; align-items: center; gap: 4px; }
  .tag button { background: none; border: none; cursor: pointer; color: #888; font-size: 14px; line-height: 1; }
  .tag-input-row { display: flex; gap: 8px; margin-top: 8px; }
  .tag-input-row input { flex: 1; }

  /* â”€â”€ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ â”€â”€ */
  #status { padding: 14px 18px; border-radius: 8px; font-size: 14px; font-weight: 600; display: none; margin-top: 16px; }
  #status.loading { background: #e8f4ff; color: #1a6eb5; display: block; }
  #status.success { background: #e8f8ee; color: #1a7a45; display: block; }
  #status.error   { background: #fef0f0; color: #c0392b; display: block; }

  /* â”€â”€ ã‚¹ãƒ”ãƒŠãƒ¼ â”€â”€ */
  .spinner { width: 16px; height: 16px; border: 2px solid #fff4; border-top-color: currentColor; border-radius: 50%; animation: spin .6s linear infinite; display: inline-block; }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* â”€â”€ ã‚¹ãƒ†ãƒƒãƒ—éè¡¨ç¤º â”€â”€ */
  #step2 { display: none; }
  #step3 { display: none; }

  .row2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
  @media (max-width: 600px) { .row2 { grid-template-columns: 1fr; } }

  /* ç™»éŒ²æ¸ˆã¿ãƒãƒŠãƒ¼ */
  #success-banner { display: none; background: #1a7a45; color: #fff; border-radius: 10px; padding: 20px 24px; text-align: center; margin-bottom: 20px; }
  #success-banner h2 { font-size: 18px; margin-bottom: 6px; }
  #success-banner p { font-size: 13px; opacity: .85; }
  #success-banner a { color: #c9a84c; font-weight: 700; }
</style>
</head>
<body>

<header>
  <h1>SCJ ã‚»ãƒŸãƒŠãƒ¼ç™»éŒ²ãƒ„ãƒ¼ãƒ«</h1>
  <span>ç®¡ç†è€…å°‚ç”¨</span>
</header>

<main>

  <!-- æˆåŠŸãƒãƒŠãƒ¼ -->
  <div id="success-banner">
    <h2>âœ… Contentfulã«ç™»éŒ²ã—ã¾ã—ãŸï¼</h2>
    <p>ã‚µã‚¤ãƒˆã¸ã®åæ˜ ã¯æ•°åˆ†å¾Œã§ã™ã€‚<a href="https://scj-4cb.pages.dev/seminars/" target="_blank">ã‚»ãƒŸãƒŠãƒ¼ãƒšãƒ¼ã‚¸ã‚’ç¢ºèª â†’</a></p>
  </div>

  <!-- STEP 1: PDFã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ -->
  <div class="card" id="step1">
    <div class="card-title">Step 1 â€” PDF ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</div>

    <div id="drop-zone">
      <div class="icon">ğŸ“„</div>
      <p>PDFã‚’ã“ã“ã«ãƒ‰ãƒ­ãƒƒãƒ—<br>ã¾ãŸã¯ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠ</p>
      <div id="file-name"></div>
    </div>
    <input type="file" id="file-input" accept=".pdf">

    <br>
    <button class="btn btn-primary" id="analyze-btn" disabled>
      <span class="spinner" id="analyze-spinner" style="display:none"></span>
      è§£æã™ã‚‹ â†’
    </button>
    <div id="status"></div>
  </div>

  <!-- STEP 2: å†…å®¹ç¢ºèªãƒ»ä¿®æ­£ -->
  <div class="card" id="step2">
    <div class="card-title">Step 2 â€” å†…å®¹ã‚’ç¢ºèªãƒ»ä¿®æ­£</div>

    <div class="form-group">
      <label>ã‚¿ã‚¤ãƒˆãƒ« <span class="req">*</span></label>
      <input type="text" id="f-title" placeholder="ä¾‹ï¼šä»¤å’Œ7å¹´åº¦ç¬¬2å›ã‚¹ãƒãƒ¼ãƒ„ã‚³ãƒŸãƒƒã‚·ãƒ§ãƒ³ã‚»ãƒŸãƒŠãƒ¼">
    </div>

    <div class="row2">
      <div class="form-group">
        <label>é–‹å‚¬æ—¥ <span class="req">*</span></label>
        <input type="date" id="f-date">
      </div>
      <div class="form-group">
        <label>åŒºåˆ†</label>
        <select id="f-category">
          <option value="ãƒ¬ãƒãƒ¼ãƒˆ">ãƒ¬ãƒãƒ¼ãƒˆï¼ˆéå»ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ï¼‰</option>
          <option value="ã‚¤ãƒ™ãƒ³ãƒˆ">ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆé–‹å‚¬äºˆå®šãƒ»ä»Šå¾Œï¼‰</option>
        </select>
      </div>
    </div>

    <div class="form-group">
      <label>é–‹å‚¬å ´æ‰€</label>
      <input type="text" id="f-venue" placeholder="ä¾‹ï¼šå‚è­°é™¢è­°å“¡ä¼šé¤¨ B109 ä¼šè­°å®¤">
    </div>

    <div class="form-group">
      <label>æœ¬æ–‡ï¼ˆPDFã®å†…å®¹ã‚’ãã®ã¾ã¾ï¼‰</label>
      <textarea id="f-body"></textarea>
    </div>

    <div class="form-group">
      <label>æ¤œç´¢ã‚¿ã‚°ï¼ˆè¬›æ¼”è€…åãƒ»ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼‰</label>
      <div class="tags-wrap" id="tags-wrap"></div>
      <div class="tag-input-row">
        <input type="text" id="tag-input" placeholder="ã‚¿ã‚°ã‚’è¿½åŠ ã—ã¦ Enter">
        <button class="btn btn-primary" onclick="addTagFromInput()">è¿½åŠ </button>
      </div>
    </div>
  </div>

  <!-- STEP 3: ç™»éŒ² -->
  <div class="card" id="step3">
    <div class="card-title">Step 3 â€” Contentfulã«ç™»éŒ²</div>
    <p style="font-size:13px;color:#666;margin-bottom:16px">å†…å®¹ã‚’ç¢ºèªã—ã¦ã€Œç™»éŒ²ã™ã‚‹ã€ã‚’æŠ¼ã™ã¨ã€è‡ªå‹•çš„ã«ã‚µã‚¤ãƒˆã«å…¬é–‹ã•ã‚Œã¾ã™ã€‚</p>
    <button class="btn btn-gold" id="submit-btn">
      <span class="spinner" id="submit-spinner" style="display:none"></span>
      Contentfulã«ç™»éŒ²ã™ã‚‹
    </button>
    <div id="submit-status"></div>
  </div>

</main>

<script>
let selectedFile = null;
let tags = [];
let rawBodyText = '';

// â”€â”€ ãƒ‰ãƒ­ãƒƒãƒ—ã‚¾ãƒ¼ãƒ³ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const dropZone = document.getElementById('drop-zone');
const fileInput = document.getElementById('file-input');

dropZone.addEventListener('click', () => fileInput.click());
dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('over'); });
dropZone.addEventListener('dragleave', () => dropZone.classList.remove('over'));
dropZone.addEventListener('drop', e => {
  e.preventDefault();
  dropZone.classList.remove('over');
  const file = e.dataTransfer.files[0];
  if (file && file.type === 'application/pdf') setFile(file);
});
fileInput.addEventListener('change', () => {
  if (fileInput.files[0]) setFile(fileInput.files[0]);
});

function setFile(file) {
  selectedFile = file;
  document.getElementById('file-name').textContent = `ğŸ“ ${file.name}`;
  document.getElementById('analyze-btn').disabled = false;
}

// â”€â”€ è§£æ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('analyze-btn').addEventListener('click', async () => {
  if (!selectedFile) return;

  setStatus('loading', 'â³ PDFã‚’è§£æä¸­...');
  document.getElementById('analyze-spinner').style.display = 'inline-block';
  document.getElementById('analyze-btn').disabled = true;

  const formData = new FormData();
  formData.append('pdf', selectedFile);

  try {
    const res = await fetch('/analyze', { method: 'POST', body: formData });
    const data = await res.json();
    if (!data.ok) throw new Error(data.error);

    const p = data.parsed;
    rawBodyText = data.rawText || '';

    // ãƒ•ã‚©ãƒ¼ãƒ ã«åæ˜ 
    document.getElementById('f-title').value = p.title || '';
    document.getElementById('f-date').value = p.date || '';
    document.getElementById('f-venue').value = p.venue || '';
    document.getElementById('f-body').value = rawBodyText;

    // ã‚¿ã‚°
    tags = p.tags || [];
    renderTags();

    // STEPã‚’è¡¨ç¤º
    document.getElementById('step2').style.display = 'block';
    document.getElementById('step3').style.display = 'block';
    document.getElementById('step2').scrollIntoView({ behavior: 'smooth', block: 'start' });

    setStatus('success', 'âœ… è§£æå®Œäº†ï¼å†…å®¹ã‚’ç¢ºèªã—ã¦ã€Œç™»éŒ²ã™ã‚‹ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚');
  } catch (e) {
    setStatus('error', `âŒ ã‚¨ãƒ©ãƒ¼: ${e.message}`);
    document.getElementById('analyze-btn').disabled = false;
  }
  document.getElementById('analyze-spinner').style.display = 'none';
});

// â”€â”€ ã‚¿ã‚° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderTags() {
  const wrap = document.getElementById('tags-wrap');
  wrap.innerHTML = '';
  tags.forEach((tag, i) => {
    const el = document.createElement('span');
    el.className = 'tag';
    el.innerHTML = `${tag}<button onclick="removeTag(${i})">Ã—</button>`;
    wrap.appendChild(el);
  });
}
function removeTag(i) { tags.splice(i, 1); renderTags(); }
function addTagFromInput() {
  const input = document.getElementById('tag-input');
  const val = input.value.trim();
  if (val && !tags.includes(val)) { tags.push(val); renderTags(); }
  input.value = '';
}
document.getElementById('tag-input').addEventListener('keydown', e => {
  if (e.key === 'Enter') { e.preventDefault(); addTagFromInput(); }
});

// â”€â”€ ç™»éŒ² â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('submit-btn').addEventListener('click', async () => {
  const title = document.getElementById('f-title').value.trim();
  const date  = document.getElementById('f-date').value;
  if (!title) { alert('ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  if (!date)  { alert('é–‹å‚¬æ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }

  document.getElementById('submit-spinner').style.display = 'inline-block';
  document.getElementById('submit-btn').disabled = true;

  const payload = {
    title,
    date,
    venue: document.getElementById('f-venue').value.trim(),
    bodyText: document.getElementById('f-body').value,
    category: document.getElementById('f-category').value,
    tags,
  };

  try {
    const res = await fetch('/submit', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload),
    });
    const data = await res.json();
    if (!data.ok) throw new Error(data.error);

    // æˆåŠŸ
    document.getElementById('success-banner').style.display = 'block';
    document.getElementById('success-banner').scrollIntoView({ behavior: 'smooth' });
    document.getElementById('step2').style.display = 'none';
    document.getElementById('step3').style.display = 'none';
    document.getElementById('step1').style.display = 'none';

  } catch (e) {
    const ss = document.getElementById('submit-status');
    ss.className = 'error';
    ss.style.display = 'block';
    ss.textContent = `âŒ ${e.message}`;
    document.getElementById('submit-btn').disabled = false;
  }
  document.getElementById('submit-spinner').style.display = 'none';
});

function setStatus(type, msg) {
  const el = document.getElementById('status');
  el.className = type;
  el.textContent = msg;
}
</script>
</body>
</html>
